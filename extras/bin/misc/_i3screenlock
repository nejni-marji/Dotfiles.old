#!/bin/bash

OPT_TEST=false
OPT_BG=false
OPT_NODELAY=false

while getopts 'tbn' OPT; do
	case ${OPT} in
		t) OPT_TEST=true ;;
		b) OPT_BG=true ;;
		n) OPT_NODELAY=true ;;
	esac
done

DIR=~/.wallpaper

if [[ $OPT_BG ]]; then
	~/bin/i3paperlock
else

	! $OPT_NODELAY && sleep .5

	get_res() {
		COUNT=$(xrandr | grep -P '([0-9]+)x([0-9]+)\+([0-9]+)\+([0-9]+)')
		[[ "$COUNT" == 1 ]] && echo 'superfail' && exit
		xrandr | grep -Po '([0-9]+)x([0-9]+)\+([0-9]+)\+([0-9]+)' | grep -Po '([0-9]+)x([0-9]+)'
	}

	params=(\
		"$DIR/prelock.png"
		"-resize" "$(get_res)!"
		"$DIR/prelock.png"
	)
	convert ${params[*]}

fi

get_brightness() {
	params=(\
		"$DIR/prelock.png"
		"-gravity center"
		"-crop $1"
		"-colorspace hsb"
		"-resize 1x1 txt:-"
	)
	printf "%.0f" \
	$(\
		convert ${params[*]} |\
		grep -Po '((?<=hsb\()|(?<=hsba\())[0-9.,%]+(?=\))' |\
		tr -d % |\
		awk -F, '{print $3}'
	)
}

#text_bright=$(get_brightness "404x76+0+160")
lock_bright=$(get_brightness "100x100+0+0")
ring_bright=$lock_bright #TODO actually check this, maybe
#time_bright=$(get_brightness "220x72+0-226")
#date_bright=$(get_brightness "350x32+0-149")

make_lock() {
	[[ $text_bright -gt 60 ]] && text_color=black || text_color=white
	[[ $lock_bright -gt 60 ]] && lock_color=dark
	! $OPT_BG && scale=("-scale" "10%" "-scale" "1000%")

	params=(\
	"$DIR/prelock.png"
	${scale[*]}

	#"-font" "Liberation-Sans"
	#"-pointsize" "32"
	#"-fill" "$text_color"
	#"-gravity" "center"
	#"-annotate" "+0+160"
	#"Type password to unlock."

	#"-gravity" "center" "$DIR/icons/circlelockclear$lock_color.png"
	#"-composite"
	"$DIR/lock.png"
	)
	convert "${params[@]}"
}

make_lock

make_i3lock() {

	[[ $ring_bright -gt 60 ]] && ring_color=000000 || ring_color=ffffff
	[[ $ring_bright -gt 60 ]] && invr_color=ffffff || invr_color=000000
	[[ $ring_bright -gt 60 ]] && sepr_color=dddddd || sepr_color=222222
	[[ $time_bright -gt 60 ]] && time_color=000000 || time_color=ffffff
	[[ $date_bright -gt 60 ]] && date_color=000000 || date_color=ffffff

	params=(\
		"--image" "$DIR/lock.png"

		"--textcolor"        "00000000"
		"--insidecolor"      "00000000"
		"--ringcolor"        "$ring_color"80

		"--linecolor"        "$ring_color"00
		"--keyhlcolor"       "$invr_color"80
		"--ringvercolor"     "$invr_color"00

		"--separatorcolor"   "$sepr_color"60
		"--insidevercolor"   "$invr_color"20

		"--ringwrongcolor"   "ff000000"
		"--insidewrongcolor" "ff000080"

		#"--clock"

		"--timecolor" "$time_color"ff
		"--timestr"   "%H:%M"
		"--timefont"  "Liberation-Sans"
		"--timesize"  "72"
		"--timepos"   "ix-(cw/2):iy-(ch/2)-200"

		"--datecolor" "$date_color"ff
		"--datestr"   "%A, %B %d"
		"--datefont"  "Liberation-Sans"
		"--datesize"  "32"
		"--datepos"   "tx:ty+60"
	)
	i3lock "${params[@]}" || i3lock -c acacac
}

$OPT_TEST && feh -F $DIR/lock.png || make_i3lock
