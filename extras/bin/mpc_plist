#!/bin/zsh

while getopts ":r:" opt; do
	case "${opt}" in
		r)
			refresh_mode="$OPTARG"
		;;
	esac
done

refresh_modes=(idle all)
[[ ${refresh_modes[(ie)$OPTARG]} -gt ${#refresh_modes} ]] \
&& refresh_mode=idle

while true; do

	clear
	position=$(mpc -f '%position%' current)
	jump=$(($position-2))
	pos_len=$(echo -n $position | wc -m)
	pos_neg=$((8-$pos_len))
	spaces=$(printf ' %.0s' {1..$(($pos_neg-3))})
	while [[ $jump -lt 1 ]]; do
		jump=$(($jump+1))
	done

	mpc playlist -f '%position%\t[[%artist% - ]%title%]|%file%' \
	| tail -n+$jump \
	| perl -pe "s/^($position)\t(.*$)/$spaces\*\1\*\t\2/" \
	| fold -s -w $(($(tput cols)-0)) \
	| head -n $(($(tput lines)-1))

	case $refresh_mode in
		all)
			mpc idle >/dev/null &
			lines=$(tput lines)
			columns=$(tput cols)

			while true; do
				read -t 1                        && act=break
				[[ $(tput cols)  -ne $columns ]] && act=break
				[[ $(tput lines) -ne $lines   ]] && act=break
				if [[ $act == break ]]; then
					kill "${${jobstates##*:*:}%=*}"
					act=""
					break
				fi
				[[ $#jobstates -eq 0 ]] && break

			done
		;;
		idle|*)
			mpc idle
			continue
		;;
	esac
done
